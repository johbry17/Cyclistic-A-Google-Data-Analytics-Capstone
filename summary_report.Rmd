---
title: "Cyclistic"
subtitle: "Analysis of difference in ridership patterns between casual and member customers"
author: "Bryan Johns"
date: "`r format(Sys.Date(), '%Y-%m')`"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    css: ./resources/css/styles.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(sf)
library(ggspatial)
```

# Google Data Analytics Capstone

A hypothetical data analysis project, answering a business question for a fictional bikeshare company, analyzing customer behavior and concluding with recommendations to assist in converting casual customers into annual members.

```{r, echo=FALSE}
# load data, combine into a df
q1_2019 = read.csv("./resources/data/q1_2019_cleaned.csv")
q2_2019 = read.csv("./resources/data/q2_2019_cleaned.csv")
q3_2019 = read.csv("./resources/data/q3_2019_cleaned.csv")
q4_2019 = read.csv("./resources/data/q4_2019_cleaned.csv")
# stations = read.csv("./resources/data/stations.csv")

df <- bind_rows(q1_2019, q2_2019, q3_2019, q4_2019)
```

## Executive Summary

Goal: Analyze historical data on Cyclistic users and provide insights for a digital marketing campaign aimed at converting casual users into annual subscription-based members. The top three recommendations are provided.

Result: Recommend focusing on converting casual weekend users into workday commuters, running an ad campaign emphasizing the benefits of commuting by bicycle, with ads targeted to popular leisure destinations and times, with accompanying promotions.

Analysis: This analysis focused on differences in the riding behavior of casual users versus annual members.

- Members are primarily commuters and secondarily leisure users. Casual tend to be 'weekend warriors' using bicycles for trips to pleasurable outings. Casual rides are longer, averaging an hour to member's 15-minute average. Member rides are unsurprisingly more numerous, 4 times more frequent.

- Member rides peak during commuters hours, weekdays at 8am and 5pm. Secondarily they use it for leisure, especially on weekends. Casual riders mostly use bicycles for weekend leisure, peaking on Saturday afternoon, with Sunday afternoon not far behind.

- Members tend to be slightly older, peaking in their early-30's, versus casual riders, peaking in their early-20's.

# Methodology

## Google's Data Analysis Framework

Google's [Data Analytics certificate](https://www.coursera.org/professional-certificates/google-data-analytics) provides an introductory training, covering spreadsheets, SQL, Tableau, and R. The capstone is optional. I used R for my analysis, to further practice that programming language, supplementing my background primarily in Python.

This report follows the certificate's framework for data analysis: Ask, Prepare, Process, Analyze, Share, Act. It corresponds to the following deliverables:

1. A clear statement of the business task (Ask)
2. A description of all data sources used (Prepare)
3. Documentation of any cleaning or manipulation of data (Process)
4. A summary of the data analysis (Analyze)
5. Supporting visualizations and key findings (Share)
6. Top three recommendations based on analysis (Act)

## Scenario

See `./resources/Case Study 1_How does a bike-share navigate speedy success.pdf`. Quoted from the Google Data Analytics Capstone:

<blockquote>You are a junior data analyst working on the marketing analyst team at Cyclistic, a bike-share
company in Chicago. The director of marketing believes the company’s future success
depends on maximizing the number of annual memberships. Therefore, your team wants to
understand how casual riders and annual members use Cyclistic bikes dierently. From these
insights, your team will design a new marketing strategy to convert casual riders into annual
members. But first, Cyclistic executives must approve your recommendations, so they must be
backed up with compelling data insights and professional data visualizations.

Characters and teams

● Cyclistic: A bike-share program that features more than 5,800 bicycles and 600
docking stations. Cyclistic sets itself apart by also offering reclining bikes, hand
tricycles, and cargo bikes, making bike-share more inclusive to people with disabilities
and riders who can’t use a standard two-wheeled bike. The majority of riders opt for
traditional bikes; about 8% of riders use the assistive options. Cyclistic users are more
likely to ride for leisure, but about 30% use the bikes to commute to work each day.

● Lily Moreno: The director of marketing and your manager. Moreno is responsible for
the development of campaigns and initiatives to promote the bike-share program.
These may include email, social media, and other channels.

● Cyclistic marketing analytics team: A team of data analysts who are responsible for
collecting, analyzing, and reporting data that helps guide Cyclistic marketing strategy.
You joined this team six months ago and have been busy learning about Cyclistic’s
mission and business goals—as well as how you, as a junior data analyst, can help
Cyclistic achieve them.

● Cyclistic executive team: The notoriously detail-oriented executive team will decide
whether to approve the recommended marketing program.

About the company

In 2016, Cyclistic launched a successful bike-share offering. Since then, the program has grown
to a fleet of 5,824 bicycles that are geotracked and locked into a network of 692 stations across
Chicago. The bikes can be unlocked from one station and returned to any other station in the
system anytime.

Until now, Cyclistic’s marketing strategy relied on building general awareness and appealing to
broad consumer segments. One approach that helped make these things possible was the
flexibility of its pricing plans: single-ride passes, full-day passes, and annual memberships.
Customers who purchase single-ride or full-day passes are referred to as casual riders.
Customers who purchase annual memberships are Cyclistic members.

Cyclistic’s finance analysts have concluded that annual members are much more profitable
than casual riders. Although the pricing flexibility helps Cyclistic attract more customers,
Moreno believes that maximizing the number of annual members will be key to future growth.
Rather than creating a marketing campaign that targets all-new customers, Moreno believes
there is a solid opportunity to convert casual riders into members. She notes that casual riders
are already aware of the Cyclistic program and have chosen Cyclistic for their mobility needs.

Moreno has set a clear goal: Design marketing strategies aimed at converting casual riders into
annual members. In order to do that, however, the team needs to better understand how
annual members and casual riders differ, why casual riders would buy a membership, and how
digital media could affect their marketing tactics. Moreno and her team are interested in
analyzing the Cyclistic historical bike trip data to identify trends.

Note that data-privacy issues prohibit you from using riders’ personally identifiable information.
This means that you won’t be able to connect pass purchases to credit card numbers to
determine if casual riders live in the Cyclistic service area or if they have purchased multiple
single passes.

Three questions will guide the future marketing program:

1. How do annual members and casual riders use Cyclistic bikes differently?
2. Why would casual riders buy Cyclistic annual memberships?
3. How can Cyclistic use digital media to influence casual riders to become members?
<br><br>

Moreno has assigned you the first question to answer: How do annual members and casual
riders use Cyclistic bikes differently?
</blockquote>

## Ask

Deliverable: A clear statement of the business task

How do annual members and casual riders use Cyclistic bikes differently? 

Base the analysis on Cyclistic historical bike trip data.

## Prepare

Deliverable: A description of all data sources used

Google provided the [data](https://divvy-tripdata.s3.amazonaws.com/index.html), meaning Lyft and Divvy provided them with data from Chicago.

> The [data](https://divvy-tripdata.s3.amazonaws.com/index.html) has been made available by Motivate International Inc. under this [license](https://divvybikes.com/data-license-agreement).

I used data for 2019, because it has info on gender and birthyear. Pretend that was last year and the data is current and useful.

## Process

Deliverable: Documentation of any cleaning or manipulation of data

Google provided a starter template to clean the data. See `data_cleaning_v1.R`.

Google's template covered only Q1 2019 and Q1 2020. I wanted to have all of 2019 available, so I modified the script to clean individual quarters of Cyclistic data. To join Q1 2019 and Q1 2020, Google's template removed trip duration, gender, and birth year from 2019, station latitude and longitude from 2020. I wanted to keep that info, so I dropped 2020 (lacking gender and birthyear), and added 2020's lat/lng to 2019.

Data cleaning consisted of:

● Extracting station latitude and longitude from 2020 and adding it to start and end stations in 2019 (labeling all but 366 of almost 4 million rows).

● Removing "tripduration" from 2019.

● Consolidating the "member_casual" column from four labels to two ("member" and "casual"), instead of the original two names for members ("member" and "Subscriber") and two names for casual riders ("Customer" and "casual").

● Extracting day, month, year, season, and day of the week from the start date and creating columns for each, to provide additional opportunities to aggregate the data.

● Adding a calculated field ("ride_length") for length of ride since the 2020Q1 data did not have
the "tripduration" column. This briefly catastrophically halted data analysis, as ride length was calculated in minutes for 2019, and seconds in 2020.

● Remvoing rides where ride_length shows up as negative, including several hundred rides where the company took bikes out of circulation for Quality Control reasons.

## Analyze

Deliverable: A summary of the data analysis

See `./resources/scratch_pad.Rmd` for further insights.

Casual rides are longer but less frequent than member rides.

Casual rides last longer than member rides (one hour vs 15 mins).

```{r, echo=FALSE}
# sum average ride length by membership type
average_ride_length <- df %>%
  group_by(member_casual) %>%
  summarise(average_minutes = mean(ride_length, na.rm = TRUE))

# print(average_ride_length)

# bar chart of average ride length
ggplot(average_ride_length, aes(x = member_casual, y = average_minutes, fill = member_casual)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = round(average_minutes, 1)), vjust = -0.5) +
  theme_minimal() +
  labs(title = "Average Ride Length by Membership Type", y = "Average Ride Length (minutes)", x = "Rider Type")
```

There are three times more member rides than casual rides (3 million vs 1 million).

```{r, echo=FALSE}
# bar chart 0f ride frequency per user
ggplot(df, aes(x = member_casual, fill = member_casual)) +
  geom_bar() +
  geom_text(stat = "count", aes(label = ..count..), vjust = -0.5) +
  labs(title = "Total Rides by Membership Type",
       x = "Rider Type",
       y = "Total Rides") +
  theme_minimal()
```

Ridership peaks in August and nadirs in February, porportionally for both groups. Winter is dead. Crickets for activity.

```{r, echo=FALSE}
# line chart of rides per month
df %>%
  group_by(month, member_casual) %>%
  summarise(rides = n()) %>%
  ggplot(aes(x = month, y = rides, color = member_casual, group = member_casual)) +
  geom_line() +
  geom_point() +
  theme_minimal() +
  labs(title = "Rides per Month, by Customer Type", x = "Month", y = "Number of Rides")
```

Casual riders ride late morning, peaking late afternoon, especially Saturday, quite a bit Sunday. Weekend Warriors. Members have two peaks - weekdays at 8am and 5pm. Commuters. They also ride roughly the same on weekends, a gentle curve from late morning to late afternoon.

```{r, echo=FALSE}
# line chart of rides per hour
df %>%
  group_by(hour, member_casual) %>%
  summarise(rides = n()) %>%
  ggplot(aes(x = hour, y = rides, color = member_casual, group = member_casual)) +
  geom_line() +
  geom_point() +
  theme_minimal() +
  labs(title = "Rides per Hour of the Day, by Customer Type", x = "Hour", y = "Number of Rides")
```
```{r, echo=FALSE}
# bar chart of rides per hour by day of week, free y-axis
df %>%
  mutate(day_of_week = factor(day_of_week, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))) %>%
  group_by(hour, member_casual, day_of_week) %>%
  summarise(rides = n()) %>%
  ggplot(aes(x = hour, y = rides, fill = member_casual)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ day_of_week, scales = "free_y") +
  theme_minimal() +
  labs(title = "Rides per Hour of Day by Customer Type and Day of Week", subtitle = "Free y-axis", x = "Hour of Day", y = "Number of Rides")
```

```{r, echo=FALSE}
# bar chart of rides / member_casual / day of week
df %>%
  mutate(day_of_week = factor(day_of_week, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))) %>%
  group_by(member_casual, day_of_week) %>%
  summarise(rides = n()) %>%
  ggplot(aes(x = member_casual, y = rides, fill = member_casual)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label = rides), vjust = -0.5, position = position_dodge(0.9)) +
  facet_wrap(~ day_of_week) +
  theme_minimal() +
  labs(title = "Rides per Member Type by Day of Week", x = "Member Type", y = "Number of Rides") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.2)))
```

Top 10 stations! Members riders go to the "Loop". They use Cyclistic for commuting to places of employment.

```{r, echo=FALSE}
# aggregate member rider counts by station
member_peak_stations <- df %>%
  filter(member_casual == "member") %>%
  count(start_station_name, sort = TRUE) %>%
  top_n(10, n)

print(member_peak_stations)

# bar chart of top stations for member riders
# ggplot(member_peak_stations, aes(x = reorder(start_station_name, n), y = n, fill = start_station_name)) +
#   geom_col(show.legend = FALSE) +
#   coord_flip() +
#   theme_minimal() +
#   labs(title = "Top Stations for Member Riders", x = "Station Name", y = "Number of Rides")
```

```{r, echo=FALSE}
# convert top member start stations to sf object
member_start_sf <- member_peak_stations %>%
  left_join(df, by = c("start_station_name")) %>% 
  distinct(start_station_name, start_lat, start_lng) %>% 
  drop_na(start_lat, start_lng) %>% 
  st_as_sf(coords = c("start_lng", "start_lat"), crs = 4326)

# plot map
ggplot() +
  annotation_map_tile(type = "osm", zoom = 12) +
  geom_sf(data = member_start_sf, color = "red", size = 3, alpha = 0.7) +
  labs(title = "Top Stations for Member Riders (Map)",
       x = "Longitude", y = "Latitude") +
  theme_minimal()
```

Casual riders seem to hit tourist / leisure destinations (I assume? Must research Chicago landmarks. "Milleniumn Park", "Shedd Aquarium", "Theater on the Lake", "Dusable Harbor", and "Adler Planetarium" sound like destinations for the occasional bike rider).

```{r,echo=FALSE}
# aggregate casual rider counts by station
casual_peak_stations <- df %>%
  filter(member_casual == "casual") %>%
  count(start_station_name, sort = TRUE) %>%
  top_n(10, n)

print(casual_peak_stations)

# bar chart of top stations for casual riders
# ggplot(casual_peak_stations, aes(x = reorder(start_station_name, n), y = n, fill = start_station_name)) +
#   geom_col(show.legend = FALSE) +
#   coord_flip() +
#   theme_minimal() +
#   labs(title = "Top Start Stations for Casual Riders", x = "Station Name", y = "Number of Rides")
```

```{r, echo=FALSE}
# map of top start stations for casual riders

# convert top casual start stations to sf object
casual_start_sf <- casual_peak_stations %>%
  left_join(df, by = c("start_station_name")) %>% # Join to get lat/lng
  distinct(start_station_name, start_lat, start_lng) %>% # Remove duplicates
  drop_na(start_lat, start_lng) %>% 
  st_as_sf(coords = c("start_lng", "start_lat"), crs = 4326)

# plot the map
ggplot() +
  annotation_map_tile(type = "osm", zoom = 12) +
  geom_sf(data = casual_start_sf, color = "blue", size = 3, alpha = 0.7) +
  labs(title = "Top Stations for Casual Riders (Map)",
       x = "Longitude", y = "Latitude") +
  theme_minimal()
```

Members are slightly older, peaking in 30-35. Casual in 25-30.

```{r, echo=FALSE}
# age distribution
ggplot(df, aes(x = 2020 - birthyear, fill = member_casual)) +
  geom_histogram(binwidth = 5, alpha = 0.7, position = "dodge") +
  # stat_bin(binwidth = 5, geom = "text", aes(label = ..count..), vjust = -0.5, position = position_dodge(5)) +
  theme_minimal() +
  labs(title = "Age Distribution by Rider Type", x = "Age", y = "Count") +
  xlim(0, 100)
```

More men ride than women. Maybe an opportunity there.

```{r, echo=FALSE}
# gender split
ggplot(df, aes(x = gender, fill = member_casual)) +
  geom_bar(position = "dodge") +
  geom_text(stat = "count", aes(label = ..count..), vjust = -0.5, position = position_dodge(0.9)) +
  theme_minimal() +
  labs(title = "Gender Breakdown by Rider Type", x = "Gender", y = "Count")
```


## Share

Deliverable: Supporting visualizations and key findings

This document, especially the [Executive Summary](#executive-summary).

## Act

Deliverable: Top three recommendations based on analysis

1. Purpose of advertising

- Ad campaign relating to using a bike for work.

- Emphasize usefulness of bikes for commuting. Maybe advertise on industry / work events, trade orgs, etc. In neighborhoods that Chicagoans commute to.

- Mention helath benefits of commuting by bike. Members are slightly older, and maybe more health conscious.

- Include member testimonials on the power of commuting by bicycle.

2. Locations / times to advertise:

- Advertise on popular websites (restaurants, newpapers, vacation boards, arts & leisure mags, 'Things To Do in Chicago') related to the top destinations of casual users (Shedd Aquarium, Theater on the Lake, et al).

- Advertise on weekends when they are riding.

3. Promotions

- End of summer sale, capitalizing on August peak ridership, when Cyclistic is top of popularity.

- Member bonuses for referring a friend to become a member.

- Free guest trial passes to people who commute at the same time as a member during peak commuting times 7-9am, 4-6pm (enlist significant others / house mates in commuting).
