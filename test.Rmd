---
title: "Test"
author: "Bryan Johns"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    includes:
      before_body: "header.html"
    css: ./resources/css/styles.css
---

<div class="floating-header">
  Cyclistic 2019 Summary Report
</div>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(fontawesome)
library(leaflet)
library(leaflet.extras)
library(tidyverse)

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# load data, combine into a df
df <- read.csv("./resources/data/2024/202401-divvy-tripdata_cleaned.csv")

# read_cyclistic_data <- function(year) {
#   for (i in 1:12) {
#     month <- sprintf("%02d", i) # Format as 01, 02, ..., 12
#     file_path <- paste0("resources/data/", year, "/", year, month, "-divvy-tripdata_cleaned.csv")
# 
#     if (file.exists(file_path)) {
#       data <- read_csv(file_path)
#       data$month <- as.character(data$month) # ensure month is character
#       assign(paste0("m", month), data, envir = .GlobalEnv)
#     } else {
#       message("File not found: ", file_path)
#     }
#   }
# }
# 
# read_cyclistic_data(2024)
# 
# # regex to bind rows of all monthly data frames
# df <- bind_rows(mget(ls(pattern = "^m\\d{2}$")))
# 
# # dump memory - invisible suppresses output
# invisible(rm(list = ls(pattern = "^m\\d{2}(_cleaned)?$")))
# invisible(gc())
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Function to get top 10 stations for start or end locations
get_top_stations <- function(data, station_col, member_type) {
  data %>%
    filter(!is.na(!!sym(station_col)), member_casual == member_type) %>%
    count(!!sym(station_col), sort = TRUE) %>%
    top_n(10, n) %>%
    pull(!!sym(station_col))
}

# Get top 10 stations
top_start_members <- get_top_stations(df, "start_station_name", "member")
top_start_casual <- get_top_stations(df, "start_station_name", "casual")

# Function to filter trips matching the top 10 stations
filter_trips <- function(data, station_list, station_col) {
  data %>% filter(!!sym(station_col) %in% station_list)
}

# Filter trips based on top stations
trips_from_top_start_members <- filter_trips(df, top_start_members, "start_station_name")
trips_from_top_start_casual <- filter_trips(df, top_start_casual, "start_station_name")

# Function to plot Leaflet heatmaps
plot_leaflet_heatmap <- function(data, lng_col, lat_col, title, zoom_level = 13) {
  data <- data %>% filter(!is.na(!!sym(lng_col)) & !is.na(!!sym(lat_col)))

  density_data <- data %>% count(!!sym(lng_col), !!sym(lat_col))
  color_palette <- colorNumeric(palette = "viridis", domain = density_data$n)

  leaflet(data) %>%
    addTiles() %>%
    setView(lng = -87.605, lat = 41.895, zoom = zoom_level) %>%
    addHeatmap(
      lng = as.formula(paste0("~", lng_col)),
      lat = as.formula(paste0("~", lat_col)),
      blur = 15, max = 1, radius = 10
    ) %>%
    addLegend(
      position = "bottomleft",
      pal = color_palette,
      values = density_data$n,
      title = title
    )
}
```

<span style="  font-size: 14pt;">Top 10 starting stations for member and casual rides</span>

<div class="map-container">
```{r, echo=FALSE, message=FALSE, warning=FALSE}
plot_leaflet_heatmap(trips_from_top_start_members, "start_lng", "start_lat", "Top Stations<br>(Members)")
```
</div>

\

<div class="map-container">
```{r, echo=FALSE, message=FALSE, warning=FALSE}
plot_leaflet_heatmap(trips_from_top_start_casual, "start_lng", "start_lat", "Top Stations<br>(Casuals)")
```
</div>

\

Compare the above 2024 maps with 2019's map of top stations and sightseeing locations.

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<i class="fas fa-book"></i>

<div class="button">
  <a href="summary_2024.html">Link to<br>Cyclistic 2024</a>
</div>

# Color Match

---

<p>
  <a href="#scenario" class="fa-icon">`r fa("info-circle")`</a> 
  For reference, the full case study details can be found in the [Appendix](#scenario).
</p>

<p>
  <a href="#data-dictionary" class="fa-icon">`r fa("book")`</a>
  A [Data Dictionary](#data-dictionary) is attached in the Appendix.
</p>

<p>
  <a href="scratch_pad_2019.html" class="fa-icon">`r fa("chart-line")`</a>
  Further insights are available in the [exploratory data analysis](scratch_pad_2024.html).
</p>



<span class="fa-container">
  <a href="#data-dictionary" class="fa-icon">`r fa("chart-bar")`</a> 
  A [Data Dictionary](#data-dictionary) is attached in the Appendix.
</span>

<span class="fa-container">
  <a href="scratch_pad_2024.html" class="fa-icon">`r fa("search")`</a>
  Further insights are available in the <a href="scratch_pad_2024.html">exploratory data analysis</a>.
</span>

<span class="fa-container">
  <a href="scratch_pad_2024.html" class="fa-icon">`r fa("chart-line")`</a>
  Further insights are available in the <a href="scratch_pad_2024.html">exploratory data analysis</a>.
</span>

<span class="fa-container">
  <a href="scratch_pad_2024.html" class="fa-icon">`r fa("database")`</a>
  Further insights are available in the <a href="scratch_pad_2024.html">exploratory data analysis</a>.
</span>




<span class="fa-container">
  <a href="#scenario" class="fa-icon">`r fa("info-circle")`</a> 
  For reference, the full case study details can be found in the [Appendix](#scenario).
</span>

\

## Data Sources

---

<div class="text-border">

The analysis incorporates cleaned ride data from all `r format(nrow(df), big.mark = ",")` bike rides of 2024, detailing trip durations, ride frequencies, station destinations, and date-time information.

Google linked to [data](https://divvy-tripdata.s3.amazonaws.com/index.html) provided by Lyft and Divvy from their Chicago operations. The data has been made available by Motivate International Inc. under this [license](https://divvybikes.com/data-license-agreement).

</div>

<span class="fa-container">
  <a href="#data-dictionary" class="fa-icon">`r fa("book")`</a> 
  A [Data Dictionary](#data-dictionary) is attached in the Appendix.
</span>





bl

bl

bl

bl

bl

bl

<span style="font-size: 10pt;">[`r fa("arrow-up")` &nbsp; Back to Data Sources](#data-sources)</span>


# Appendix
<span style="font-size: 10pt;">[`r fa("arrow-up")` &nbsp; Back to Top](#)</span>

---

bleh


# Appendix
<span style="font-size: 10pt;">[`r fa("arrow-up")` &nbsp; Back to Top](#)</span>

---

ta da
